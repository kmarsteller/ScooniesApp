<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Scoonies - NCAA Tournament Team Selection</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .tournament-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        
        .region {
            flex: 1;
            min-width: 220px;
            max-width: 24%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .region-title {
            text-align: center;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #dc3545;
            color: #dc3545;
            font-weight: bold;
        }
        
        .team-row {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .seed {
            width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .team-logo {
            width: 30px;
            height: 30px;
            margin: 0 10px;
            object-fit: contain;
        }
        
        .team-name {
            flex-grow: 1;
        }
        
        .team-button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
        }
        
        .team-button.unpurchase {
            background-color: #dc3545;
        }
        
        .team-button.disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .selected {
            background-color: rgba(40, 167, 69, 0.2);
        }
        
        .unaffordable {
            background-color: rgba(108, 117, 125, 0.2);
        }
        
        .balance-display {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            background-color:#f8f9fa;
            border: 2px solid #dc3545;
        }
        
        .selected-teams {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .selected-team-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-team-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .selected-team-logo {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        
        .team-cost {
            display: inline-block;
            margin-left: 5px;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .main-title {
            text-align: center;
            font-size: 36px;
            color: #dc3545;
            margin-bottom: 30px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .user-info-form {
            max-width: 600px;
            margin: 0 auto 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
        }
        
        /* Donation Modal Styles */
        .donation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .donation-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .donation-header {
            background-color: #dc3545;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .donation-header h2 {
            margin: 0;
            font-size: 22px;
            color: white;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .donation-body {
            padding: 20px;
        }
        
        .donation-body > p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .donation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .donation-option {
            flex: 1;
            min-width: 250px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .donation-option:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .donation-option img {
            height: 40px;
            margin-bottom: 10px;
            object-fit: contain;
        }
        
        .donation-option h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .donation-option p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .donation-amounts {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .amount-btn {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .amount-btn:hover, .amount-btn.selected {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .donate-btn {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            transition: all 0.2s ease;
            margin-top: 10px;
        }
        
        .donate-btn:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .venmo-info {
            margin-bottom: 15px;
        }
        
        .qr-code {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .placeholder-qr {
            color: #666;
            font-size: 12px;
        }
        
        .donation-footer {
            text-align: center;
            margin-top: 20px;
        }
        
        .skip-btn {
            background: none;
            border: none;
            color: #6c757d;
            text-decoration: underline;
            cursor: pointer;
            padding: 5px;
        }
        
        .skip-btn:hover {
            color: #5a6268;
        }
        
        .donation-note {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }
        
        /* Thank You Message Styles */
        .thank-you-message {
            text-align: center;
            padding: 30px 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .thank-you-message h3 {
            color: #28a745;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .thank-you-message p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #495057;
        }
        
        .thank-you-message .donate-btn {
            font-size: 18px;
            padding: 12px 30px;
            background-color: #28a745;
        }
        
        .thank-you-message .donate-btn:hover {
            background-color: #218838;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 1200px) {
            .region {
                max-width: 48%;
            }
        }
        
        @media (max-width: 768px) {
            .region {
                max-width: 100%;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .donation-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <img src="Scoonies.jpg" alt="The Scoonies Logo">
        </div>
        <nav>
            <a href="/">About</a>
            <a href="/submit.html" class="active">Make a Scoonie</a>
            <a href="/standings.html">Standings</a>
            <a href="/admin">Admin</a>
        </nav>
    </header>
    
    <main>        
        <h1 class="main-title">Make a Scoonie</h1>
        
        <form id="entryForm">
            <div class="user-info-form">
                <h2>Entry Information</h2>
                <div class="form-row">
                    <div class="form-field">
                        <label for="playerName">Your Name:</label>
                        <input type="text" id="playerName" name="playerName" required>
                    </div>
                    <div class="form-field">
                        <label for="nickname">Entry Nickname:</label>
                        <input type="text" id="nickname" name="nickname" required>
                    </div>
                </div>
                <div class="form-field">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email" name="email" required>
                </div>
            </div>
            
            <div class="balance-display">
                Points Remaining: <span id="balanceDisplay">200</span>
            </div>
            
            <div class="tournament-container" id="tournamentContainer">
                <!-- Regions will be loaded here dynamically -->
                <div class="loading">Loading teams...</div>
            </div>
            
            <div class="selected-teams">
                <h2>Your Selected Teams</h2>
                <div id="selectedTeamsList" class="selected-team-list">
                    <p id="noTeamsMessage">No teams selected yet</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="submitEntry" type="button">Submit Your Entry</button>
            </div>
        </form>
        
        <div id="message"></div>
        
        <!-- Donation Modal -->
        <div id="donationModal" style="display: none;" class="donation-modal">
            <div class="donation-content">
                <div class="donation-header">
                    <h2>Support The Scoonies</h2>
                    <button id="closeDonation" class="close-btn">&times;</button>
                </div>
                <div class="donation-body">
                    <p>Thank you for participating in The Scoonies! Would you like to make a small donation to help cover our costs?</p>
                    
                    <div class="donation-options">
                        <div class="donation-option paypal">
                            <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal">
                            <h3>Donate with PayPal</h3>
                            <p>Quick and secure payment using PayPal</p>
                            <div class="donation-amounts">
                                <button class="amount-btn selected" data-amount="5">$5</button>
                                <button class="amount-btn" data-amount="10">$10</button>
                                <button class="amount-btn" data-amount="20">$20</button>
                            </div>
                            <a href="#" id="paypalDonateBtn" class="donate-btn" target="_blank">Donate via PayPal</a>
                        </div>
                        
                        <div class="donation-option venmo">
                            <img src="https://cdn1.venmo.com/marketing/images/branding/venmo-icon.svg" alt="Venmo">
                            <h3>Send via Venmo</h3>
                            <p>Use Venmo to send your donation</p>
                            <div class="venmo-info">
                                <p>Venmo: <strong>@YourVenmoUsername</strong></p>
                                <p>Scan with your phone:</p>
                                <div id="venmoQRCode" class="qr-code">
                                    <!-- Replace this comment with an actual QR code image -->
                                    <!-- <img src="venmo-qr-code.png" alt="Venmo QR Code"> -->
                                    <div class="placeholder-qr">QR Placeholder</div>
                                </div>
                            </div>
                            <a href="https://venmo.com/YourVenmoUsername" class="donate-btn" target="_blank">Open Venmo</a>
                        </div>
                    </div>
                    
                    <div class="donation-footer">
                        <button id="skipDonation" class="skip-btn">Maybe Next Time</button>
                        <p class="donation-note">All donations are voluntary and not tax-deductible.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; 2025 The Scoonies</p>
    </footer>
    
    <script>
        // Debugging variables
        let debugMode = true;
        let debugLog = [];

        // Debug logging function
        function debug(message) {
            if (debugMode) {
                const timestamp = new Date().toISOString();
                const logMessage = `${timestamp}: ${message}`;
                console.log(logMessage);
                debugLog.push(logMessage);
                
                // Keep log in localStorage for persistence
                try {
                    localStorage.setItem('scooniesDebugLog', JSON.stringify(debugLog));
                } catch (e) {
                    console.warn('Could not save debug log to localStorage', e);
                }
            }
        }

        // Add global error handling to catch any unexpected errors
        window.addEventListener('error', function(event) {
            debug(`ERROR: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`);
        });

        // Monitor DOM modifications to see if something is removing the modal
        function setupMutationObserver() {
            // Select the donation modal
            const donationModal = document.getElementById('donationModal');
            if (!donationModal) return;
            
            // Create a MutationObserver to watch for changes to the modal
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        debug(`Donation modal style changed to: ${donationModal.style.display}`);
                        if (donationModal.style.display === 'none') {
                            debug(`ALERT: Donation modal was hidden! Stack trace: ${new Error().stack}`);
                        }
                    }
                });
            });
            
            // Start observing the modal for style changes
            observer.observe(donationModal, { attributes: true });
            debug('Mutation observer started for donation modal');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            debug('DOM loaded, initializing app');
            
            // Load any existing debug log
            try {
                const savedLog = localStorage.getItem('scooniesDebugLog');
                if (savedLog) {
                    debugLog = JSON.parse(savedLog);
                }
            } catch (e) {
                console.warn('Could not load debug log from localStorage', e);
            }
            
            // Setup mutation observer
            setTimeout(setupMutationObserver, 1000);
            
            // Variables to track game state
            let balance = 200;
            let selectedTeams = [];
            
            // Calculate cost based on seed
            function getTeamCost(seed) {
                return Math.max(5, 80 - ((seed - 1) * 5));
            }
            
            // Add this function to show status messages instead of alerts
            function showStatusMessage(message, type) {
                const messageDiv = document.getElementById('message');
                if (!messageDiv) return;
                
                messageDiv.textContent = message;
                messageDiv.className = type;
                
                // Clear message after a delay
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = '';
                }, 3000);
            }
            
            // Load teams from CSV
            fetch('/teams.csv')
                .then(response => response.text())
                .then(data => {
                    debug('Teams CSV data loaded');
                    // Parse CSV
                    const rows = data.split('\n').filter(row => row.trim());
                    const headers = rows[0].split(',');
                    const teamData = rows.slice(1).map(row => {
                        const values = row.split(',');
                        return {
                            seed: parseInt(values[0]),
                            logoUrl: values[1],
                            teamName: values[2],
                            region: values[3]
                        };
                    });
                    
                    // Group by region
                    const regions = {};
                    teamData.forEach(team => {
                        if (!regions[team.region]) {
                            regions[team.region] = [];
                        }
                        regions[team.region].push(team);
                    });
                    
                    // Sort teams by seed within each region
                    for (const region in regions) {
                        regions[region].sort((a, b) => a.seed - b.seed);
                    }
                    
                    // Clear loading message
                    document.getElementById('tournamentContainer').innerHTML = '';
                    
                    // Create region columns - ensure 4 columns for four regions
                    const sortedRegions = Object.keys(regions).sort(); // East, Midwest, South, West
                    
                    sortedRegions.forEach(region => {
                        const regionDiv = document.createElement('div');
                        regionDiv.className = 'region';
                        
                        const regionTitle = document.createElement('div');
                        regionTitle.className = 'region-title';
                        regionTitle.textContent = region + ' Region';
                        regionDiv.appendChild(regionTitle);
                        
                        // Add teams to region
                        regions[region].forEach(team => {
                            const teamRow = document.createElement('div');
                            teamRow.className = 'team-row';
                            teamRow.dataset.seed = team.seed;
                            teamRow.dataset.team = team.teamName;
                            teamRow.dataset.region = team.region;
                            teamRow.dataset.logo = team.logoUrl;
                            teamRow.dataset.cost = getTeamCost(team.seed);
                            
                            const seed = document.createElement('div');
                            seed.className = 'seed';
                            seed.textContent = team.seed;
                            
                            const logo = document.createElement('img');
                            logo.className = 'team-logo';
                            logo.src = team.logoUrl;
                            logo.alt = team.teamName + ' logo';
                            
                            const teamName = document.createElement('div');
                            teamName.className = 'team-name';
                            teamName.textContent = team.teamName;
                            
                            const cost = getTeamCost(team.seed);
                            const affordable = cost <= balance;
                            
                            const button = document.createElement('button');
                            button.className = affordable ? 'team-button' : 'team-button disabled';
                            button.textContent = affordable ? `Purchase (${cost} pts)` : 'Can\'t Afford';
                            button.type = 'button'; // Ensure it's a button, not submit
                            
                            if (affordable) {
                                button.addEventListener('click', function(e) {
                                    // Prevent default to avoid form submission
                                    e.preventDefault();
                                    e.stopPropagation();
                                    toggleTeamSelection(teamRow);
                                    return false;
                                });
                            }
                            
                            teamRow.appendChild(seed);
                            teamRow.appendChild(logo);
                            teamRow.appendChild(teamName);
                            teamRow.appendChild(button);
                            
                            if (!affordable) {
                                teamRow.classList.add('unaffordable');
                            }
                            
                            regionDiv.appendChild(teamRow);
                        });
                        
                        document.getElementById('tournamentContainer').appendChild(regionDiv);
                    });
                    
                    debug('Regions and teams rendered');
                    
                    // Update all team rows' affordability
                    updateAffordability();
                    
                    // Initialize submit button
                    const submitBtn = document.getElementById('submitEntry');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', function(e) {
                            debug('Submit button clicked');
                            e.preventDefault();
                            e.stopPropagation();
                            handleFormSubmission();
                            return false;
                        });
                    }
                    
                    // Check if entry submissions are open
                    checkEntryStatus();
                    
                    // Initialize donation modal
                    setupDonationModal();
                })
                .catch(error => {
                    debug(`Error loading teams: ${error.message}`);
                    console.error('Error loading teams:', error);
                    document.getElementById('tournamentContainer').innerHTML = 
                        '<div class="error">Error loading teams. Please refresh the page or try again later.</div>';
                });
            
            // Function to check if entries are open
            function checkEntryStatus() {
                debug('Checking entry status');
                fetch('/api/entries/status')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch entry status');
                        }
                        return response.json();
                    })
                    .then(data => {
                        debug(`Entry status received: entriesOpen=${data.entriesOpen}`);
                        if (!data.entriesOpen) {
                            // Entries are closed
                            disableSubmission("SUBMIT DEADLINE HAS PASSED");
                            
                            // Show message
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'error';
                            messageDiv.style.textAlign = 'center';
                            messageDiv.style.padding = '20px';
                            messageDiv.style.marginBottom = '20px';
                            messageDiv.style.backgroundColor = '#f8d7da';
                            messageDiv.style.color = '#721c24';
                            messageDiv.style.borderRadius = '4px';
                            messageDiv.textContent = 'The deadline for submitting entries has passed. You can no longer make new entries.';
                            
                            // Insert after the form title
                            const formTitle = document.querySelector('.main-title');
                            formTitle.parentNode.insertBefore(messageDiv, formTitle.nextSibling);
                        }
                    })
                    .catch(error => {
                        debug(`Error checking entry status: ${error.message}`);
                        console.error('Error checking entry status:', error);
                    });
            }
            
            // Function to disable the submission form
            function disableSubmission(buttonText) {
                debug(`Disabling submission with button text: ${buttonText}`);
                // Disable all form fields
                const formFields = document.querySelectorAll('input, select, textarea');
                formFields.forEach(field => {
                    field.disabled = true;
                });
                
                // Disable team buttons
                const teamButtons = document.querySelectorAll('.team-button');
                teamButtons.forEach(button => {
                    button.disabled = true;
                    button.classList.add('disabled');
                });
                
                // Update submit button
                const submitButton = document.getElementById('submitEntry');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = buttonText;
                    submitButton.style.backgroundColor = '#6c757d'; // Gray color
                    submitButton.style.cursor = 'not-allowed';
                }
            }
            
            // Toggle team selection
            function toggleTeamSelection(teamRow) {
                debug(`Toggling team selection for: ${teamRow.dataset.team} (${teamRow.dataset.region})`);
                const seed = parseInt(teamRow.dataset.seed);
                const teamName = teamRow.dataset.team;
                const region = teamRow.dataset.region;
                const logo = teamRow.dataset.logo;
                const cost = parseInt(teamRow.dataset.cost);
                
                const isSelected = teamRow.classList.contains('selected');
                const button = teamRow.querySelector('.team-button');
                
                if (isSelected) {
                    // Remove team from selection
                    teamRow.classList.remove('selected');
                    button.textContent = `Purchase (${cost} pts)`;
                    button.classList.remove('unpurchase');
                    
                    // Update balance
                    balance += cost;
                    debug(`Removed team, new balance: ${balance}`);
                    
                    // Update selected teams array
                    selectedTeams = selectedTeams.filter(team => 
                        !(team.teamName === teamName && team.region === region));
                } else {
                    // Check if there's enough balance
                    if (cost > balance) {
                        debug(`Not enough points for team: cost=${cost}, balance=${balance}`);
                        showStatusMessage('Not enough points for this team!', 'error');
                        return;
                    }
                    
                    // Add team to selection
                    teamRow.classList.add('selected');
                    button.textContent = `Remove (${cost} pts)`;
                    button.classList.add('unpurchase');
                    
                    // Update balance
                    balance -= cost;
                    debug(`Added team, new balance: ${balance}`);
                    
                    // Add to selected teams array
                    selectedTeams.push({
                        seed,
                        teamName,
                        region,
                        logo,
                        cost
                    });
                }
                
                // Update balance display
                document.getElementById('balanceDisplay').textContent = balance;
                
                // Update selected teams list
                renderSelectedTeamsList();
                
                // Update affordability of all teams
                updateAffordability();
            }
            
            // Completely re-render the selected teams list
            function renderSelectedTeamsList() {
                debug('Rendering selected teams list');
                const listElement = document.getElementById('selectedTeamsList');
                
                // Clear previous content
                listElement.innerHTML = '';
                
                if (selectedTeams.length === 0) {
                    // Show no teams message
                    const noTeamsMessage = document.createElement('p');
                    noTeamsMessage.id = 'noTeamsMessage';
                    noTeamsMessage.textContent = 'No teams selected yet';
                    listElement.appendChild(noTeamsMessage);
                    return;
                }
                
                // Sort by region and seed
                const sortedTeams = [...selectedTeams].sort((a, b) => {
                    if (a.region !== b.region) {
                        return a.region.localeCompare(b.region);
                    }
                    return a.seed - b.seed;
                });
                
                // Add each team to the list
                sortedTeams.forEach(team => {
                    const teamTag = document.createElement('div');
                    teamTag.className = 'selected-team-tag';
                    
                    const logoImg = document.createElement('img');
                    logoImg.className = 'selected-team-logo';
                    logoImg.src = team.logo;
                    logoImg.alt = team.teamName;
                    
                    const teamText = document.createElement('span');
                    teamText.textContent = `#${team.seed} ${team.teamName} - ${team.region}`;
                    
                    const costSpan = document.createElement('span');
                    costSpan.className = 'team-cost';
                    costSpan.textContent = `(${team.cost} pts)`;
                    
                    teamTag.appendChild(logoImg);
                    teamTag.appendChild(teamText);
                    teamTag.appendChild(costSpan);
                    
                    listElement.appendChild(teamTag);
                });
            }
            
            // Update affordability of all teams
            function updateAffordability() {
                debug(`Updating affordability for all teams with balance: ${balance}`);
                const teamRows = document.querySelectorAll('.team-row');
                
                teamRows.forEach(row => {
                    if (row.classList.contains('selected')) {
                        return; // Skip already selected teams
                    }
                    
                    const cost = parseInt(row.dataset.cost);
                    const button = row.querySelector('.team-button');
                    
                    if (cost > balance) {
                        row.classList.add('unaffordable');
                        button.textContent = 'Can\'t Afford';
                        button.classList.add('disabled');
                        button.disabled = true;
                    } else {
                        row.classList.remove('unaffordable');
                        button.textContent = `Purchase (${cost} pts)`;
                        button.classList.remove('disabled');
                        button.disabled = false;
                    }
                });
            }
            
            // Handle donation modal functionality
            function setupDonationModal() {
                debug('Setting up donation modal');
                
                const donationModal = document.getElementById('donationModal');
                const closeDonationBtn = document.getElementById('closeDonation');
                const skipDonationBtn = document.getElementById('skipDonation');
                const paypalDonateBtn = document.getElementById('paypalDonateBtn');
                const amountBtns = document.querySelectorAll('.amount-btn');
                let selectedAmount = 5; // Default amount
                
                // Set your PayPal details
                const paypalUsername = 'YourPayPalEmail@example.com'; // Replace with your actual PayPal email/username
                
                // Function to go to standings page
                function goToStandings() {
                    debug('Redirecting to standings page');
                    window.location.href = '/standings.html';
                }
                
                // Update PayPal donation link when amount changes
                function updatePayPalLink() {
                    paypalDonateBtn.href = `https://www.paypal.com/donate/?business=${encodeURIComponent(paypalUsername)}&amount=${selectedAmount}&currency_code=USD&no_recurring=1`;
                    debug(`Updated PayPal link with amount: ${selectedAmount}`);
                }
                
                // Initialize PayPal link
                updatePayPalLink();
                
                // Amount button click
                amountBtns.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        debug(`Amount button clicked: ${this.dataset.amount}`);
                        // Prevent any default actions
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Remove selected class from all buttons
                        amountBtns.forEach(b => b.classList.remove('selected'));
                        
                        // Add selected class to clicked button
                        this.classList.add('selected');
                        
                        // Update selected amount
                        selectedAmount = this.dataset.amount;
                        updatePayPalLink();
                        
                        return false; // Extra precaution
                    });
                });
                
                // Close modal on X button click and redirect
                if (closeDonationBtn) {
                    closeDonationBtn.addEventListener('click', function(e) {
                        debug('Close button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        donationModal.style.display = 'none';
                        goToStandings();
                        return false;
                    });
                } else {
                    debug('WARNING: Close donation button not found!');
                }
                
                // Close modal on "Maybe Next Time" click and redirect
                if (skipDonationBtn) {
                    skipDonationBtn.addEventListener('click', function(e) {
                        debug('Skip donation button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        donationModal.style.display = 'none';
                        goToStandings();
                        return false;
                    });
                } else {
                    debug('WARNING: Skip donation button not found!');
                }
                
                // Handle PayPal donation button click - open in new window
                if (paypalDonateBtn) {
                    paypalDonateBtn.addEventListener('click', function(e) {
                        debug('PayPal button clicked');
                        // Prevent default action
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Open PayPal in a new window
                        window.open(this.href, '_blank');
                        debug('Opened PayPal in new window');
                        
                        // Show thank you message and continue button
                        showThankYou();
                        return false;
                    });
                } else {
                    debug('WARNING: PayPal donate button not found!');
                }
                
                // Handle Venmo button click - open in new window
                const venmoBtn = document.querySelector('.venmo .donate-btn');
                if (venmoBtn) {
                    venmoBtn.addEventListener('click', function(e) {
                        debug('Venmo button clicked');
                        // Prevent default action
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Open Venmo in a new window
                        window.open(this.href, '_blank');
                        debug('Opened Venmo in new window');
                        
                        // Show thank you message and continue button
                        showThankYou();
                        return false;
                    });
                } else {
                    debug('WARNING: Venmo button not found!');
                }
                
                // Function to show thank you message
                function showThankYou() {
                    debug('Showing thank you message');
                    // Find elements
                    const donationBody = document.querySelector('.donation-body');
                    const donationOptions = document.querySelector('.donation-options');
                    const donationFooter = document.querySelector('.donation-footer');
                    
                    if (donationOptions && donationFooter) {
                        // Hide options and footer
                        donationOptions.style.display = 'none';
                        donationFooter.style.display = 'none';
                        
                        // Create thank you message and continue button
                        const thankYouDiv = document.createElement('div');
                        thankYouDiv.className = 'thank-you-message';
                        thankYouDiv.innerHTML = `
                            <h3>Thank you for your support!</h3>
                            <p>After completing your donation, click the button below to continue.</p>
                            <button id="continueBtn" class="donate-btn">Continue to Standings</button>
                        `;
                        
                        // Add to donation body
                        donationBody.appendChild(thankYouDiv);
                        debug('Added thank you message to DOM');
                        
                        // Add event listener to continue button
                        document.getElementById('continueBtn').addEventListener('click', function(e) {
                            debug('Continue button clicked');
                            e.preventDefault();
                            e.stopPropagation();
                            goToStandings();
                            return false;
                        });
                    } else {
                        debug('ERROR: Could not find donation options or footer elements');
                    }
                }
            }
            
            // Global function to show donation modal
            window.showDonationModal = function() {
                debug('showDonationModal function called');
                const donationModal = document.getElementById('donationModal');
                if (donationModal) {
                    donationModal.style.display = 'flex';
                    debug('Set donation modal display to flex');
                    
                    // Add an extra check to ensure it stays visible
                    setTimeout(() => {
                        if (donationModal && donationModal.style.display !== 'flex') {
                            debug('WARNING: Modal was hidden! Showing it again...');
                            donationModal.style.display = 'flex';
                        }
                    }, 100);
                } else {
                    debug('ERROR: Donation modal element not found!');
                }
            };
            
            // Form submission handler
            function handleFormSubmission() {
                debug('Form submission handler called');
                
                // Get form field values
                const playerNameInput = document.getElementById('playerName');
                const nicknameInput = document.getElementById('nickname');
                const emailInput = document.getElementById('email');
                
                if (!playerNameInput || !nicknameInput || !emailInput) {
                    debug('ERROR: One or more form input elements not found!');
                    return;
                }
                
                const playerName = playerNameInput.value.trim();
                const nickname = nicknameInput.value.trim();
                const email = emailInput.value.trim();
                
                debug(`Form values: playerName=${playerName}, nickname=${nickname}, email=${email}`);
                
                // Validate form fields
                if (!playerName || !nickname || !email) {
                    debug('Validation failed: Missing required fields');
                    alert('Please fill in all required fields: Name, Nickname, and Email');
                    return;
                }
                
                // Calculate total points spent
                const pointsSpent = selectedTeams.reduce((sum, team) => sum + team.cost, 0);
                const startingPoints = 200;
                
                debug(`Points spent: ${pointsSpent} of ${startingPoints}`);
                
                // Enforce exactly 200 points spent - only at submission time
                if (pointsSpent !== startingPoints) {
                    debug(`Validation failed: Points spent (${pointsSpent}) != ${startingPoints}`);
                    alert(`You must spend exactly 200 points. Currently you've spent ${pointsSpent} points.`);
                    return;
                }
                
                if (selectedTeams.length === 0) {
                    debug('Validation failed: No teams selected');
                    alert('Please select at least one team before submitting.');
                    return;
                }
                
                // Prepare data for submission
                const formData = {
                    playerName,
                    nickname,
                    email,
                    selectedTeams
                };
                
                debug('Submitting form data to server...');
                
                // Disable submit button to prevent double-submissions
                const submitBtn = document.getElementById('submitEntry');
                if (submitBtn) submitBtn.disabled = true;
                
                // Submit entry to server
                fetch('/api/entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                })
                .then(response => {
                    debug(`Server response status: ${response.status}`);
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    debug('Entry submission successful!');
                    
                    // Show success message
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.textContent = data.message || 'Entry submitted successfully!';
                        messageDiv.className = 'success';
                    }
                    
                    // Disable the form after submission
                    if (playerNameInput) playerNameInput.disabled = true;
                    if (nicknameInput) nicknameInput.disabled = true;
                    if (emailInput) emailInput.disabled = true;
                    
                    // Disable all team buttons
                    document.querySelectorAll('.team-button').forEach(button => {
                        button.disabled = true;
                    });
                    
                    debug('Form disabled after successful submission');
                    
                    // Show donation modal
                    debug('Showing donation modal...');
                    setTimeout(() => {
                        showDonationModal();
                        
                        // Extra safeguard - check again after a short delay
                        setTimeout(() => {
                            const donationModal = document.getElementById('donationModal');
                            if (donationModal && donationModal.style.display !== 'flex') {
                                debug('ALERT: Donation modal was hidden too quickly! Showing it again...');
                                donationModal.style.display = 'flex';
                            }
                        }, 100);
                    }, 500);
                })
                .catch(error => {
                    debug(`Error submitting entry: ${error.message}`);
                    console.error('Error submitting entry:', error);
                    
                    // Re-enable submit button if submission failed
                    if (submitBtn) submitBtn.disabled = false;
                    
                    // Show error message
                    const messageDiv = document.getElementById('message');
                    if (messageDiv) {
                        messageDiv.textContent = error.message || 'Error submitting entry. Please try again.';
                        messageDiv.className = 'error';
                    }
                });
            }
        });
    </script>
</body>
</html>